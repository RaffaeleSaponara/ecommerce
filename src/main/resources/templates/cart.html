<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrello Ecommerce</title>
    <link rel="stylesheet" href="/css/home.css">
    <style>
        /* Aggiunta di stile specifico per il carrello */
        .carrello-container {
            width: 80%;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        }

        .carrello-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .carrello-item img {
            max-width: 100px;
            height: auto;
        }

        .carrello-item-info {
            flex: 1;
            margin-left: 15px;
        }

        .carrello-item h3 {
            margin: 0;
            font-size: 16px;
            color: #007bff;
        }

        .carrello-item p {
            margin: 5px 0;
            font-size: 14px;
        }

        .carrello-item-price {
            font-size: 16px;
            font-weight: bold;
            color: #28a745;
        }

        .remove-button {
            background-color: red;
            color: white;
            border: none;
            padding: 3px 6px; /* Ridotto a metà della dimensione precedente */
            font-size: 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            margin-left: 15px; /* Aggiunto spazio tra il bottone e il prezzo */
        }

        .remove-button:hover {
            background-color: #cc0000;
        }

        .totale-container {
            display: flex;
            justify-content: flex-end;
            padding-top: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .payment-button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 16px;
            display: block;
            margin-top: 20px;
            width: 100%;
            text-align: center;
            transition: background 0.3s;
        }

        .payment-button:hover {
            background-color: #0056b3;
        }

        .no-items {
            text-align: center;
            font-size: 18px;
            color: #888;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        Il tuo Carrello
    </header>
    <nav>
        <div>
            <a href="/home">Home</a>
            <a href="/prodotti">Prodotti</a>
            <a href="#">Offerte</a>
            <a href="#">Contatti</a>
        </div>
        <div class="auth-container">
            <a href="/login" class="login-button" id="loginButton">Login</a>
            <a href="/logout" class="logout-button" id="logoutButton" style="display: none;">Logout</a>
            <div class="profile-icon" id="profileIcon" style="display: none;">
                <a href="/profilo"><img src="/images/icon.jpg" alt="Profilo"></a>
            </div>
            <div class="cart-icon" id="cartIcon" style="display: none;">
                <a href="/cart"><img src="/images/cart.png" alt="Cart"></a>
            </div>
        </div>
    </nav>

    <div id="carrello-container" class="carrello-container">
        <p>Caricamento del carrello...</p>
    </div>

    <div class="totale-container" id="totale-container">
        <span>Totale: €<span id="totale">0.00</span></span>
    </div>

    <a href="/checkout" class="payment-button" id="paymentButton">Procedi con il pagamento</a>

</div>
<footer>
    &copy; 2025 E-Commerce. Tutti i diritti riservati.
</footer>

<script>
 // Funzione per rimuovere il prodotto dal carrello
        function rimuoviProdotto(id) {
            fetch(`/cart/remove/${id}`, {  // URL per rimuovere il prodotto
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella rimozione del prodotto');
                }
                // Ricarica il carrello dopo la rimozione
                caricaCarrello();
            })
            .catch(error => {
                alert(`Errore nella rimozione del prodotto: ${error.message}`);
            });
        }

// Funzione per ottenere il carrello tramite Fetch API
function caricaCarrello() {
    fetch('/cart/view')  // URL del controller Spring MVC
        .then(response => {
            if (!response.ok) {
                throw new Error('Errore nel recupero del carrello');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.items && data.items.length > 0) {
                let carrelloHTML = '';
                let totale = 0;

                data.items.forEach(item => {
                    const prezzo = item.prezzo;
                    totale += prezzo;

                    carrelloHTML += `
                        <div class="carrello-item" data-item-id="${item.id}">
                            <img src="${item.image}" alt="${item.nome}">
                            <div class="carrello-item-info">
                                <h3>${item.nome}</h3>
                                <p><strong>Descrizione:</strong> ${item.descrizione}</p>
                                <p><strong>Categoria:</strong> ${item.categoria}</p>
                            </div>
                            <div class="carrello-item-price">€${prezzo}</div>
                            <button class="remove-button" onclick="rimuoviProdotto(${item.id})">x</button>
                        </div>
                    `;
                });

                document.getElementById('carrello-container').innerHTML = carrelloHTML;
                document.getElementById('totale').textContent = totale.toFixed(2);
            } else {
                document.getElementById('carrello-container').innerHTML = '<p class="no-items">Il carrello è vuoto.</p>';
            }
        })
        .catch(error => {
            document.getElementById('carrello-container').innerHTML = `<p class="no-items">Errore nel caricamento del carrello: ${error.message}</p>`;
    });
}
    document.addEventListener('DOMContentLoaded', function() {


        // Carica il carrello quando la pagina è pronta
        caricaCarrello();

        // Gestione dell'autenticazione
        const loginButton = document.getElementById("loginButton");
        const profileIcon = document.getElementById("profileIcon");
        const logoutButton = document.getElementById("logoutButton");
        const cartIcon = document.getElementById("cartIcon");

        fetch("/auth/check")
            .then(response => response.json())
            .then(isAuthenticated => {
                if (isAuthenticated) {
                    localStorage.setItem("isAuthenticated", "true");
                    loginButton.style.display = "none";
                    logoutButton.style.display = "block";
                    profileIcon.style.display = "block";
                    cartIcon.style.display = "block";
                } else {
                    localStorage.removeItem("isAuthenticated");
                    loginButton.style.display = "block";
                    logoutButton.style.display = "none";
                    profileIcon.style.display = "none";
                    cartIcon.style.display = "none";
                }
            })
            .catch(error => console.error("Errore nel recupero dell'autenticazione:", error));
    });
</script>

</body>
</html>
